// 约球啦 - 数据库 Schema
// 使用 PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  wechatId  String?  @unique @map("wechat_id")
  phone     String?  @unique
  email     String?  @unique
  password  String?  // hashed, for email/password auth only
  name      String?
  ntrpLevel Decimal? @map("ntrp_level") @db.Decimal(2, 1) // 1.5 - 7.0
  gender    String?  // "male" | "female" | "other" | "prefer_not_to_say"
  birthYear Int?     @map("birth_year") // for age calculation
  sports    Json?    @default("[]") // ["tennis", "badminton", ...]
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  gamesCreated    Game[]            @relation("GameHost")
  participations  GameParticipant[]
  messagesSent    Message[]

  @@map("users")
}

model Venue {
  id          String   @id @default(cuid())
  name        String
  address     String
  lat         Decimal  @db.Decimal(10, 7)
  lng         Decimal  @db.Decimal(10, 7)
  amapPlaceId String?  @map("amap_place_id")
  createdAt   DateTime @default(now()) @map("created_at")

  games Game[]

  @@map("venues")
}

model Game {
  id              String   @id @default(cuid())
  venueId         String   @map("venue_id")
  hostId          String   @map("host_id")
  sport           String   @default("tennis")
  ntrpMin         Decimal  @map("ntrp_min") @db.Decimal(2, 1)
  ntrpMax         Decimal  @map("ntrp_max") @db.Decimal(2, 1)
  startTime       DateTime @map("start_time")
  durationMinutes Int     @default(60) @map("duration_minutes")
  maxParticipants Int     @default(4) @map("max_participants")
  joinPolicy      String   @default("open") @map("join_policy") // "open" | "approval_required"
  status          String   @default("active") // "active" | "cancelled" | "completed"
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  venue       Venue            @relation(fields: [venueId], references: [id], onDelete: Cascade)
  host        User             @relation("GameHost", fields: [hostId], references: [id], onDelete: Cascade)
  participants GameParticipant[]
  messages    Message[]

  @@map("games")
}

model GameParticipant {
  id     String @id @default(cuid())
  gameId String @map("game_id")
  userId String @map("user_id")
  role   String @default("participant") // "host" | "participant"
  status String @default("confirmed")   // "pending" | "confirmed" | "rejected"
  joinedAt DateTime @default(now()) @map("joined_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
  @@map("game_participants")
}

model Message {
  id        String   @id @default(cuid())
  gameId    String   @map("game_id")
  senderId  String   @map("sender_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model OtpVerification {
  id         String   @id @default(cuid())
  identifier String   // email or phone
  code       String
  type       String   // "email" | "phone"
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([identifier, type])
  @@map("otp_verifications")
}
